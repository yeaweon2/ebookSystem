<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.ebook.prj.bcnfm.mapper.BcnfmMapper">
	<select id="bcnfmList" resultType="co.ebook.prj.bcnfm.vo.BcnfmVO">
   	   SELECT rownum as bcnfmNo
            , c.bcnfm_id
            , b.book_id
            , b.book_cover
            , b.book_cover_path
            , ( SELECT member_nm FROM member m where m.member_id = b.member_id ) as bcnfm_req_nm
            , b.book_nm            
            , bcnfm_req_dt
            , nvl( ( SELECT scodes.scode_nm FROM scodes 
                WHERE lcode = 'BC' AND scode = c.bcnfm_st_cd ), '미신청') as bcnfmStCd
            , bcnfm_cnfm_dt
            , ( SELECT member_nm FROM member m where m.member_id = c.bcnfm_cnfmr ) as bcnfm_cnfmr 
            , ( select count(1) from book_attach where book_id = b.book_id ) as fileCnt
		 FROM book b
		    ,  book_confirm c  
       WHERE b.book_id = c.book_id 
       order by nvl( c.bcnfm_st_cd, '04') 
	</select>
	
	<insert id="bcnfmInsert" parameterType="co.ebook.prj.bcnfm.vo.BcnfmVO">
	INSERT INTO BOOK_CONFIRM (
		BCNFM_ID 	, BOOK_ID		, BCNFM_REQ_DT	, 
		BCNFM_ST_CD , INS_DT		, UDT_DT
	) VALUES ( 
 		bcnfm_seq.nextval 	, #{bookId}			, SYSDATE			, 
 		'01' 				, SYSDATE	   		, SYSDATE ) 
	</insert>
	
	<update id="bcnfmUpdate" parameterType="co.ebook.prj.bcnfm.vo.BcnfmVO">
		UPDATE BOOK_CONFIRM
		   SET BCNFM_ST_CD = #{bcnfmStCd}
		   <if test="bcnfmStCd != null and bcnfmStCd != ''">
				<if test="bcnfmStCd.equals('02')">
				 , BCNFM_CNFMR = #{bcnfmCnfmr}
				 , BCNFM_CNFM_DT = SYSDATE
				 , BCNFM_REJECT = null
				</if>
				<if test="bcnfmStCd.equals('03')">
				 , BCNFM_REJECT = #{bcnfmReject}
				</if>		   	 
			</if>
		     , UDT_DT = SYSDATE
		 WHERE BCNFM_ID = #{bcnfmId}
	</update>

	<update id="bcnfmIdUpdate">
		UPDATE BOOK
       	   SET BCNFM_ID = ( SELECT MAX(BCNFM_ID) FROM BOOK_CONFIRM 
       	   					 WHERE BOOK_ID = #{bookId} )
       	   	 , book_cnfm_yn = 'Y'
 		 WHERE BOOK_ID = #{bookId}		
	</update>
</mapper>